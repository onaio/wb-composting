{% extends 'base_municipality.jinja2' %}
{% block title %}Overview{% endblock %}
{% block description %}Quick overview{% endblock %}
{% block breadcrumbs %}
{% endblock breadcrumbs %}
{% block content %}

{% if trend_data == 'null' %}
<div class="row">
    <div class="col-sm-4">
        <div class="well well-lg text-center"> 
            No Site Reports Saved
        </div>
    </div>
</div>
{% else %}
<div class="row clearfix">
    <div class="col-sm-6 col-sm-offset-3 text-center">
        <h3>{% trans %}Site Report Summary for {% endtrans %}{{municipality.name}}</h3>
    </div>
</div>
<div class="chart row clearfix">
    <div id="chart" class="col-sm-8"></div>
    <div class="col-sm-3">
        <p id="choices"></p>
    </div>
</div>
<div class="row clearfix">
	<table class="table table-bordered tablesaw" 
    	data-mode="swipe" data-minimap data-sortable>
        <thead>
            <th data-priority="persist" data-sortable-col data-sortable-default-col>{% trans %}Year{% endtrans %}</th>
            {% for key in site_reports[0].report_json.iterkeys()|sort %}
                <th data-priority="{{loop.index}}" data-sortable-col>{{key | capitalize | replace("_", " ") | replace("msw", "MSW")}}</th>
            {% endfor %}
        </thead>
        <tbody>
            {% for report in site_reports|sort(attribute='report_date') %}
            <tr>
                <td>{{report.report_date.strftime("%B-%Y")}}</td>
                {% for key, value in report.report_json|dictsort %}
                    <td>{{value or "-"}}</td>
                {% endfor%}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% endblock %}
{% block page_scripts %}

<!-- jQuery 1.11.1 -->
<script type="text/javascript" src="{{ request.static_url('composting:static/js/jquery.min.js') }}"></script>
<!-- Bootstrap -->
<script src="{{ request.static_url('composting:static/js/bootstrap.min.js') }}" type="text/javascript"></script>
<!-- Tablesaw -->
<script src="{{ request.static_url('composting:static/js/tablesaw.min.js') }}" type="text/javascript"></script>

<script src="{{ request.static_url('composting:static/js/plugins/flot/jquery.flot.min.js') }}" type="text/javascript"></script>
<script src="{{ request.static_url('composting:static/js/plugins/flot/jquery.flot.time.js') }}" type="text/javascript"></script>
<script src="{{ request.static_url('composting:static/js/plugins/flot/jquery.flot.stack.min.js') }}" type="text/javascript"></script>
<script src="{{ request.static_url('composting:static/js/plugins/flot/jquery.flot.resize.min.js') }}" type="text/javascript"></script>

<script type="text/javascript">

    $(function() {
        var datasets = {{trend_data | safe()}};

        // hard-code color indices to prevent them from shifting as
        // indicators are turned on and off
        var i = 0;
        $.each(datasets, function(key, val) {
            val.color = i;
            ++i;
        });
        // insert checkboxes 
        var choiceContainer = $("#choices");
        var selectContainer = $("<select/>",{name: 'indicators', class: 'form-control'});
        $.each(datasets, function(key, val) {
            selectContainer.append($("<option />", {value:key, text: val.label}));
        });
        choiceContainer.append(selectContainer);

        selectContainer.change(plotAccordingToChoices);

        function plotAccordingToChoices() {
            var data = [];
            var key = selectContainer.val();
                if (key && datasets[key]) {
                    data.push(datasets[key]);
                }
            if (data.length > 0) {
                $.plot("#chart", data, {
                    series: {
                        lines: {
                            show: true,
                            steps: false
                        },
                        points: {
                            show: true
                        }
                    },
                    yaxis: {
                        min: 0
                    },
                    xaxis: {
                        mode: "time",
                        minTickSize: [1, "month"],
                        timeformat: "%b-%Y"
                    },
                    grid: {
                        hoverable: true
                    },
                });
            }
        }
        plotAccordingToChoices();

        $("<div id='tooltip'></div>").css({
            position: "absolute",
            display: "none",
            border: "1px solid #fdd",
            padding: "2px",
            "background-color": "#fee",
            opacity: 0.80
        }).appendTo("body");

        $("#chart").bind("plothover", function (event, pos, item) {
            if (item) {
                var x = item.datapoint[0],
                    y = item.datapoint[1].toFixed(2),
                    selectedDate = new Date(x);
                var selectedDateName = $.plot.formatDate(selectedDate, '%b');
                $("#tooltip").html(selectedDateName + ": " + y)
                    .css({top: item.pageY+5, left: item.pageX+5})
                    .fadeIn(200);
            } else {
                $("#tooltip").hide();
            }
        });

    });

</script>
{% endblock %}